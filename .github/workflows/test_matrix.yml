name: Build Components

on:
  push:
    branches:
      - development
  pull_request:
    branches:
      - development

jobs:
  set-matrix:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        event: ["push", "pull_request"]

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v2

      - name: Set Matrix and Build
        id: set-matrix
        uses: ./.github/actions/test_matrix
        with:
          event: ${{ matrix.event }}

  use-matrix:
    needs: set-matrix
    runs-on: ubuntu-latest
    strategy:
      matrix: ${{fromJson(needs.set-matrix.outputs.matrix)}}
    steps:
      - name: Use matrix
        run: |
          matrix="${{ needs.set-matrix.outputs.matrix }}"
          components=$(echo "$matrix" | jq -r '.components | join(",")')
          paths=$(echo "$matrix" | jq -r '.paths | join(",")')
          docker_files=$(echo "$matrix" | jq -r '.docker_files | join(",")')
          working_dirs=$(echo "$matrix" | jq -r '.working_dirs | join(",")')
          image_names=$(echo "$matrix" | jq -r '.image_names | join(",")')

          echo "Component: $components"
          echo "Paths: $paths"
          echo "Dockerfile: $docker_files"
          echo "Working Directory: $working_dirs"
          echo "Image Name: $image_names"