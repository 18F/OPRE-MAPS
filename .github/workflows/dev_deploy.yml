name: Deployment

on:
  push:
    branches:
      - development

jobs:

  unit-tests:
    name: Unit Tests
    uses: ./.github/workflows/unit_test_reusable.yml

  development:
    name: Deploy to Development
    needs:
      - unit-tests
    runs-on: ubuntu-latest
    env:
      NODE_ENV: production
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-python@v4
        with:
          python-version: '3.x'
      - uses: actions/setup-node@v3
        with:
          node-version: 18
          cache: 'yarn'
          cache-dependency-path: '**/yarn.lock'
      - name: Install CF CLI
        run: |
          mkdir -p $HOME/bin
          export PATH=$HOME/bin:$PATH
          curl -L "https://cli.run.pivotal.io/stable?release=linux64-binary" | tar xzv -C $HOME/bin
      - name: Install frontend dependencies
        working-directory: ./frontend
        run: yarn install --production --frozen-lockfile
      - name: Deploy backend to Cloud.gov
        id: backend-deploy
        run: |
          export PATH=$HOME/bin:$PATH
          cf login -a https://api.fr.cloud.gov -u ${{ secrets.DEV_USER }} -p ${{ secrets.DEV_PASSWORD }} -o ${{ secrets.ORG_NAME }} -s ${{ secrets.SPACE_NAME }}
          cf push opre-ops-test -f manifest.yml
          BACKEND_GUID=$(cf app opre-ops-test --guid)
          BACKEND_DOMAIN=$(cf curl /v3/apps/$BACKEND_GUID/env | jq -r .application_env_json.VCAP_APPLICATION.application_uris[0])
          echo "::set-output name=BACKEND_DOMAIN::${BACKEND_DOMAIN}"
      - name: Build frontend
        working-directory: ./frontend
        run: REACT_APP_BACKEND_DOMAIN=https://${{steps.backend-deploy.outputs.BACKEND_DOMAIN}} yarn build
      - name: Deploy frontend to Cloud.gov
        run: |
          export PATH=$HOME/bin:$PATH
          cp ./frontend/Staticfile ./frontend/build/
          cf login -a https://api.fr.cloud.gov -u ${{ secrets.DEV_USER }} -p ${{ secrets.DEV_PASSWORD }} -o ${{ secrets.ORG_NAME }} -s ${{ secrets.SPACE_NAME }}
          cf push opre-ops-frontend-test -f manifest.yml
