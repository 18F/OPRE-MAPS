{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "adminUsername": {
            "type": "string",
            "metadata": {
                "description": "Username for the virtual machine."
            }
        },
        "adminPassword": {
            "type": "securestring",
            "metadata": {
                "description": "Password for the virtual machine."
            }
        },
        "dataImportImage": {
            "type": "string",
            "metadata": {
                "description": "Container image for the data-import service."
            }
        },
        "backendImage": {
            "type": "string",
            "metadata": {
                "description": "Container image for the backend service."
            }
        },
        "dbImage": {
            "type": "string",
            "metadata": {
                "description": "Container image for the PostgreSQL DB service."
            }
        },
        "frontendImage": {
            "type": "string",
            "metadata": {
                "description": "Container image for the frontend service."
            }
        },
        "postgresPassword": {
            "type": "securestring",
            "metadata": {
                "description": "Password for the PostgreSQL database."
            }
        }
    },
    "variables": {
        "#": "== Resources ==",
        "db-name": "[concat(parameters('resourceNamePrefix'), '-db', parameters('resourceNamePostfix'))]",
        "data-import-task-name": "[concat(parameters('resourceNamePrefix'), '-data-import', parameters('resourceNamePostfix'))]",
        "backend-name": "[concat(parameters('resourceNamePrefix'), '-backend', parameters('resourceNamePostfix'))]",
        "frontend-name": "[concat(parameters('resourceNamePrefix'), '-frontend', parameters('resourceNamePostfix'))]",

        "dataImportContainerName": "ops-data-import",
        "backendContainerName": "ops-backend",
        "dbContainerName": "ops-db",
        "frontendContainerName": "ops-frontend",
        "dataImportPort": 8080,
        "backendPort": 8080,
        "dbPort": 5432,
        "frontendPort": 3000,
        "dataImportCommand": "bash -c \"python ./data_tools/src/import_static_data/load_db.py && DATA=./data_tools/data/portfolio_data.json5 python ./data_tools/src/import_static_data/import_data.py && DATA=./data_tools/data/funding_partner_data.json5 python ./data_tools/src/import_static_data/import_data.py && DATA=./data_tools/data/funding_source_data.json5 python ./data_tools/src/import_static_data/import_data.py && DATA=./data_tools/data/research_project_data.json5 python ./data_tools/src/import_static_data/import_data.py && DATA=./data_tools/data/can_data.json5 python ./data_tools/src/import_static_data/import_data.py && DATA=./data_tools/data/user_data.json5 python ./data_tools/src/import_static_data/import_data.py && DATA=./data_tools/data/agreements_and_blin_data.json5 python ./data_tools/src/import_static_data/import_data.py && DATA=./data_tools/data/team_leader_data.json5 python ./data_tools/src/import_static_data/import_data.py\"",
        "backendCommand": "python -m flask run --debug --host=0.0.0.0 --port=8080",
        "frontendEnvironmentVariable": "REACT_APP_BACKEND_DOMAIN=http://localhost:8080"
    },
    "resources": [
        {
            "type": "Microsoft.DBforPostgreSQL/flexibleServers",
            "apiVersion": "2022-11-01-preview",
            "name": "[variables('db-name')]",
            "location": "eastus",
            "dependsOn": [
                "[parameters('virtualNetworkLinkDeploymentName')]"
            ],
            "tags": {
                "Owner": "tdonaworth"
            },
            "sku": {
                "name": "Standard_B1ms",
                "tier": "Burstable"
            },
            "identity": "[json('null')]",
            "properties": {
                "createMode": "Default",
                "administratorLogin": "postgres",
                "administratorLoginPassword": "[parameters('administratorLoginPassword')]",
                "availabilityZone": "",
                "Backup": {
                    "backupRetentionDays": "7",
                    "geoRedundantBackup": "Disabled"
                },
                "highAvailability": {
                    "mode": "Disabled",
                    "standbyAvailabilityZone": ""
                },
                "dataencryption": "[json('null')]",
                "Network": {
                    "DelegatedSubnetResourceId": "/subscriptions/91ab8ed2-74e6-4366-aaf5-036186ec70db/resourceGroups/OPRE-API-ACR/providers/Microsoft.Network/virtualNetworks/OPRE-API-ACR-vnet/subnets/default",
                    "PrivateDnsZoneArmResourceId": "/subscriptions/91ab8ed2-74e6-4366-aaf5-036186ec70db/resourceGroups/OPRE-API-ACR/providers/Microsoft.Network/privateDnsZones/opre-db.private.postgres.database.azure.com"
                },
                "Storage": {
                    "StorageSizeGB": "32",
                    "iopsTier": ""
                },
                "version": "14",
                "authConfig": {}
            }
        },
        {
            "name": "[variables('dataImportContainerName')]",
            "type": "Microsoft.ContainerInstance/containerGroups",
            "apiVersion": "2021-11-01",
            "location": "[resourceGroup().location]",
            "dependsOn": [
                "[resourceId('Microsoft.ContainerInstance/containerGroups', variables('dbContainerName'))]"
            ],
            "properties": {
                "containers": [
                    {
                        "name": "[variables('dataImportContainerName')]",
                        "properties": {
                            "image": "[parameters('dataImportImage')]",
                            "ports": [
                                {
                                    "port": "[variables('dataImportPort')]"
                                }
                            ],
                            "resources": {
                                "requests": {
                                    "cpu": 1,
                                    "memoryInGB": 1
                                }
                            },
                            "command": [
                                "/bin/bash",
                                "-c",
                                "[variables('dataImportCommand')]"
                            ],
                            "environmentVariables": [
                                {
                                    "name": "ENV",
                                    "value": "local"
                                }
                            ],
                            "volumeMounts": [
                                {
                                    "name": "backend-volume",
                                    "mountPath": "/home/app/ops_api"
                                }
                            ],
                            "livenessProbe": {
                                "httpGet": {
                                    "path": "/",
                                    "port": "[variables('dataImportPort')]"
                                },
                                "initialDelaySeconds": 10,
                                "periodSeconds": 5,
                                "timeoutSeconds": 5,
                                "successThreshold": 1,
                                "failureThreshold": 3
                            }
                        }
                    }
                ],
                "volumes": [
                    {
                        "name": "backend-volume",
                        "emptyDir": {}
                    }
                ],
                "ipAddress": {
                    "type": "Public",
                    "ports": [
                        {
                            "protocol": "TCP",
                            "port": "[variables('dataImportPort')}"
                        }
                    ]
                }
            }
        },
        {
            "name": "[variables('backendContainerName')]",
            "type": "Microsoft.ContainerInstance/containerGroups",
            "apiVersion": "2021-11-01",
            "location": "[resourceGroup().location]",
            "dependsOn": [
                "[resourceId('Microsoft.ContainerInstance/containerGroups', variables('dbContainerName'))]"
            ],
            "properties": {
                "containers": [
                    {
                        "name": "[variables('backendContainerName')]",
                        "properties": {
                            "image": "[parameters('backendImage')]",
                            "ports": [
                                {
                                    "port": "[variables('backendPort')]"
                                }
                            ],
                            "resources": {
                                "requests": {
                                    "cpu": 1,
                                    "memoryInGB": 1
                                }
                            },
                            "command": [
                                "bash",
                                "-c",
                                "[variables('backendCommand')]"
                            ],
                            "environmentVariables": [
                                {
                                    "name": "JWT_PRIVATE_KEY",
                                    "secureValue": "[parameters('adminPassword')]"
                                },
                                {
                                    "name": "JWT_PUBLIC_KEY",
                                    "secureValue": "[parameters('adminPassword')]"
                                },
                                {
                                    "name": "OPS_CONFIG",
                                    "value": "environment/local/container.py"
                                }
                            ],
                            "volumeMounts": [
                                {
                                    "name": "backend-volume",
                                    "mountPath": "/home/app/ops"
                                }
                            ],
                            "livenessProbe": {
                                "httpGet": {
                                    "path": "/",
                                    "port": "[variables('backendPort')]"
                                },
                                "initialDelaySeconds": 10,
                                "periodSeconds": 10,
                                "timeoutSeconds": 10,
                                "successThreshold": 1,
                                "failureThreshold": 3
                            }
                        }
                    }
                ],
                "volumes": [
                    {
                        "name": "backend-volume",
                        "emptyDir": {}
                    }
                ],
                "ipAddress": {
                    "type": "Public",
                    "ports": [
                        {
                            "protocol": "TCP",
                            "port": "[variables('backendPort')}"
                        }
                    ]
                }
            }
        },
        {
            "name": "[variables('frontendContainerName')]",
            "type": "Microsoft.ContainerInstance/containerGroups",
            "apiVersion": "2021-11-01",
            "location": "[resourceGroup().location]",
            "dependsOn": [
                "[resourceId('Microsoft.ContainerInstance/containerGroups', variables('backendContainerName'))]"
            ],
            "properties": {
                "containers": [
                    {
                        "name": "[variables('frontendContainerName')]",
                        "properties": {
                            "image": "[parameters('frontendImage')]",
                            "ports": [
                                {
                                    "port": "[variables('frontendPort')]"
                                }
                            ],
                            "resources": {
                                "requests": {
                                    "cpu": 1,
                                    "memoryInGB": 1
                                }
                            },
                            "environmentVariables": [
                                {
                                    "name": "[variables('frontendEnvironmentVariable')]"
                                }
                            ],
                            "volumeMounts": [
                                {
                                    "name": "frontend-volume",
                                    "mountPath": "/home/app"
                                }
                            ],
                            "livenessProbe": {
                                "httpGet": {
                                    "path": "/",
                                    "port": "[variables('frontendPort')]"
                                },
                                "initialDelaySeconds": 15,
                                "periodSeconds": 10,
                                "timeoutSeconds": 5,
                                "successThreshold": 1,
                                "failureThreshold": 3
                            }
                        }
                    }
                ],
                "volumes": [
                    {
                        "name": "frontend-volume",
                        "emptyDir": {}
                    }
                ],
                "ipAddress": {
                    "type": "Public",
                    "ports": [
                        {
                            "protocol": "TCP",
                            "port": "[variables('frontendPort')}"
                        }
                    ]
                }
            }
        }
    ],
    "outputs": {
        "dbIpAddress": {
            "type": "string",
            "value": "[reference(resourceId('Microsoft.ContainerInstance/containerGroups', variables('dbContainerName')), '2021-11-01').ipAddress.ip]"
        },
        "dataImportIpAddress": {
            "type": "string",
            "value": "[reference(resourceId('Microsoft.ContainerInstance/containerGroups', variables('dataImportContainerName')), '2021-11-01').ipAddress.ip]"
        },
        "backendIpAddress": {
            "type": "string",
            "value": "[reference(resourceId('Microsoft.ContainerInstance/containerGroups', variables('backendContainerName')), '2021-11-01').ipAddress.ip]"
        },
        "frontendIpAddress": {
            "type": "string",
            "value": "[reference(resourceId('Microsoft.ContainerInstance/containerGroups', variables('frontendContainerName')), '2021-11-01').ipAddress.ip]"
        }
    }
}
